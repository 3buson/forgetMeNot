(()=>{"use strict";const e={issueUpdatedTimestamps:"issueUpdatedTimestamps",lastChanged:"lastChanged",credentials:"credentials"};function t(t,n){return new Promise((a=>chrome.storage.local.set({[e[t]]:n},(()=>a()))))}function n(t){return new Promise((n=>{chrome.storage.local.get().then((a=>{n(a[e[t]])}))}))}function a(t){return new Promise((n=>{chrome.storage.sync.get().then((a=>{n(a[e[t]])}))}))}let s=null,i=0;async function o(){await async function(){console.log("Loading issues from Jira.");const e=await a("credentials");if(!e||!e.email||!e.apiKey)return console.warn("Credentials not present! Cannot fetch from Jira."),void chrome.runtime.openOptionsPage();const n={method:"GET",headers:{Authorization:`Basic ${btoa(`${e.email}:${e.apiKey}`)}`}};return fetch('https://celtra.atlassian.net/rest/api/3/search?jql=assignee%20%3D%20currentUser()%20and%20status%20in%20("Code%20review"%2C%20"Spec%20review")',n).then((e=>e.json())).then((e=>{console.log("Issues loaded, saving into storage."),t("issueUpdatedTimestamps",e.issues.map((e=>e.fields.updated))),t("lastChanged",Date.now())})).catch((e=>console.error(e)))}(),r(await async function(){const e=await n("issueUpdatedTimestamps");return Array.isArray(e)?e.length:0}(),await async function(){const e=await n("issueUpdatedTimestamps");return Array.isArray(e)?e.reduce(((e,t)=>{const n=(new Date).getTime(),a=new Date(t).getTime();return Math.abs(n-a)>864e5?e+1:e}),0):0}())}function r(e,t){if(0===e)return void chrome.action.setIcon({path:"../../public/icon128.png"});if(0===t)return void chrome.action.setIcon({path:"../../public/bunny_0.png"});i++;const n=i%4;chrome.action.setIcon({path:`../../public/bunny_${n}.png`}),s&&(clearTimeout(s),s=null),s=setTimeout((()=>r(e,t)),50)}var c;!function(e){e.NEW_USER="NEW_USER"}(c||(c={})),a("credentials").then((e=>{e&&(document.getElementById("email").value=e.email(document.getElementById("api-key")).value=e.apiKey)})),document.getElementById("save").addEventListener("click",(function(){const t=document.getElementById("email").value,n=document.getElementById("api-key").value;return("credentials",a={email:t,apiKey:n},new Promise((t=>chrome.storage.sync.set({[e.credentials]:a},(()=>t()))))).then((()=>{!async function(e){console.log(`Tracking user event: '${JSON.stringify(e)}'.`);const t={method:"POST",headers:{accept:"text/plain","content-type":"application/json"},body:JSON.stringify([{event:"forgetMeNot",properties:{token:"a61ea6c0c2d34a4760e65c00ac58edaa",time:Date.now(),...e}}])};fetch("https://api-eu.mixpanel.com/track",t).then((()=>console.log("User signup tracking successful"))).catch((e=>console.error(e)))}({event:c.NEW_USER,distinct_id:t.split("@")[0],identifier:t.split("@")[0]}),document.getElementById("status").textContent="Credentials saved!",setTimeout((()=>{o(),chrome.tabs.getCurrent((e=>chrome.tabs.remove(e.id)))}),500)}));var a}))})();